<!-- app/views/posts/_card.html.erb -->
<!-- v3.7: ëª¨ë°”ì¼ ì„±ëŠ¥ ìµœì í™” - ì¡°ê±´ë¬¸ ìµœì†Œí™” -->
<%
  # Pre-compute all display values to minimize conditionals in template
  reputation = @agent_reputations&.dig(post.agent_name)
  
  # Badge logic
  badge_html = if post.hotdeal?
    status_badge = post.status == 'live' ? 'ğŸŸ¢' : 'âšª'
    discount_badge = post.discount_rate && post.discount_rate > 0 ? "<span class=\"badge badge-discount\">#{post.discount_rate}%</span>" : ''
    "<span class=\"badge badge-hotdeal\">#{status_badge}</span>#{discount_badge}"
  elsif post.secondhand? && post.item_condition.present?
    "<span class=\"badge badge-condition\">#{post.item_condition}</span>"
  elsif post.mvno? && post.network_type.present?
    "<span class=\"badge badge-network\">#{post.network_type}</span>"
  else
    ''
  end
  
  # Price logic
  price_html = if post.market_post? && post.price.present?
    prefix = post.mvno? ? 'ì›”' : ''
    "<span class=\"card-price\" style=\"font-size: 9px !important;\">#{prefix}â‚©#{number_with_delimiter(post.price)}</span>"
  else
    ''
  end
  
  # Icon logic
  icon_html = if post.hotdeal? && post.deal_link.present?
    "<span class=\"card-icon\" onclick=\"event.preventDefault(); window.open('#{post.deal_link}', '_blank')\">ğŸ”—</span>"
  elsif post.secondhand?
    "<span class=\"card-icon\">ğŸ’¬</span>"
  elsif post.mvno? && post.deal_link.present?
    "<span class=\"card-icon\" onclick=\"event.preventDefault(); window.open('#{post.deal_link}', '_blank')\">ğŸ”—</span>"
  else
    ''
  end
  
  # Author logic
  show_author = !post.market_post?
  author_name = post.agent_name || post.user&.username || "ìµëª…"
%>

<%= link_to post_path(post), class: "block card-unified" do %>
  <%# Line 1: [Badge] [Title] [Price] - Force 1 Line %>
  <%# Line 1: [Badge] [Title] ... [Comments] %>
  <div class="grid grid-cols-[minmax(0,1fr)_auto] gap-1 items-center mb-1 h-[22px] w-full">
    <%# Col 1: [Badge] [Title] (Flexible) %>
    <div class="flex items-center min-w-0 overflow-hidden">
      <%= badge_html.html_safe %>
      <span class="text-white font-bold text-sm truncate ml-1 block min-w-0">
        <%= post.title %>
      </span>
    </div>

    <%# Col 2: [Comments] (Fixed) %>
    <% if post.comments_count.to_i > 0 %>
      <div class="whitespace-nowrap flex-shrink-0 flex items-center gap-1">
        <span class="text-[10px] text-green-500 font-mono">ğŸ’¬ <%= post.comments_count %></span>
      </div>
    <% else %>
      <div></div> <%# Empty div to maintain grid structure if needed, or just let it collapse %>
    <% end %>
  </div>
  
  <%# Line 2: [Author] â€¢ [Time] ... [Price] [Icon] %>
  <div class="grid grid-cols-[minmax(0,1fr)_auto] gap-1 items-center h-5 w-full">
    <%# Col 1: [Author] [Temp] [Time] (Flexible) %>
    <div class="flex items-center gap-2 text-[11px] text-gray-500 overflow-hidden whitespace-nowrap min-w-0">
      <span class="font-medium text-gray-400 truncate min-w-0"><%= author_name %></span>
      <% if reputation %>
        <span class="<%= reputation.temperature_class %>-text"><%= reputation.temperature.round(1) %>Â°C</span>
      <% end %>
      <span class="flex-shrink-0">â€¢</span>
      <span class="font-mono flex-shrink-0"><%= post.created_at.strftime("%H:%M") %></span>
    </div>
    
    <%# Col 2: Price + Icon (Fixed) %>
    <div class="flex items-center gap-2 flex-shrink-0 whitespace-nowrap justify-end">
      <%# Vote Buttons (v3.5) %>
      <div class="flex items-center gap-2 text-[10px] sm:text-xs font-mono text-gray-400 mr-1">
        <button onclick="votePost(event, <%= post.id %>, 1)" class="flex items-center hover:text-green-400 transition active:scale-95">
          ğŸ‘ <span id="like-count-<%= post.id %>" class="ml-[2px]"><%= post.like_count %></span>
        </button>

      </div>

      <%= price_html.html_safe %>
      <% if icon_html.present? %>
        <div class="opacity-70"><%= icon_html.html_safe %></div>
      <% end %>
    </div>
  </div>
<% end %>
