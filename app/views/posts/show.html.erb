<main class="max-w-lg mx-auto px-3 sm:px-4 py-4 sm:py-6 w-full min-w-0">
  <%# Back Link %>
  <div class="mb-3 sm:mb-4">
    <%= link_to posts_path, class: "text-gray-400 hover:text-white text-xs sm:text-sm" do %>
      ← 목록으로
    <% end %>
  </div>

  <%# Post %>
  <article class="border-b border-neutral-800 pb-4 sm:pb-6">
    <div class="mb-4 sm:mb-6">
      <div class="flex items-center gap-2 mb-2">
         <%# Badges %>
         <% if @post.hotdeal? %>
            <span class="badge badge-hotdeal">
              <%= @post.status == 'live' ? '🟢' : '⚪' %>
            </span>
            <% if @post.discount_rate && @post.discount_rate > 0 %>
              <span class="badge badge-discount"><%= @post.discount_rate %>%</span>
            <% end %>
         <% elsif @post.secondhand? && @post.item_condition.present? %>
            <span class="badge badge-condition"><%= @post.item_condition %></span>
         <% elsif @post.mvno? && @post.network_type.present? %>
            <span class="badge badge-network"><%= @post.network_type %></span>
         <% end %>
      </div>

      <h1 class="text-lg sm:text-xl font-bold text-white mb-2 sm:mb-3"><%= @post.title %></h1>
      
      <%# Price %>
      <% if @post.market_post? && @post.price.present? %>
        <div class="text-xl sm:text-2xl font-bold text-white mb-3 font-mono">
          <% if @post.mvno? %>
            <span class="text-sm font-normal text-gray-400">월</span>
          <% end %>
          ₩<%= number_with_delimiter(@post.price) %>
        </div>
      <% end %>

      <%# Mobile: 2 lines / Desktop: 1 line %>
      <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 text-xs text-gray-500 pb-3 sm:pb-4 border-b border-neutral-800">
        <div class="flex items-center gap-2">
          <span><%= @post.agent_name || @post.user&.username || @post.user&.email&.split('@')&.first || "익명" %></span>
          <% if @agent_reputation %>
             <span class="<%= @agent_reputation.temperature_class %>-text"><%= @agent_reputation.temperature.round(1) %>°C</span>
          <% end %>
          <span class="hidden sm:inline">|</span>
          <span><%= @post.created_at.strftime("%m.%d %H:%M") %></span>
        </div>
        
        <% if user_signed_in? && (@post.user == current_user || current_user.admin?) %>
          <div class="sm:ml-auto flex gap-3 mt-1 sm:mt-0">
            <%= link_to "수정", edit_post_path(@post), class: "hover:text-white" %>
            <%= button_to "삭제", post_path(@post), method: :delete, data: { turbo_confirm: "정말 삭제하시겠습니까?" }, class: "hover:text-white" %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="text-xs sm:text-sm text-gray-300 leading-relaxed whitespace-pre-wrap mb-4 sm:mb-6"><%= @post.content %></div>

    <%# Action Buttons (Link & Chat) %>
    <% if @post.deal_link.present? || @post.secondhand? %>
      <div class="flex gap-3 mb-6">
        <%# Deal Link %>
        <% if @post.deal_link.present? %>
          <%= link_to @post.deal_link, target: "_blank", class: "flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg text-center flex items-center justify-center gap-2 transition" do %>
            <span>🔗 보러가기</span>
          <% end %>
        <% end %>

        <%# Chat Button (For all Seconhand Posts) %>
        <%# Condition: It is secondhand, and I am NOT the author %>
        <%# Note: If not logged in, they can still try to chat (will become Guest) or we can force login. For now, we allow clicking. %>
        <% is_my_post = user_signed_in? && (@post.user == current_user) %> 
        
        <% if @post.secondhand? && !is_my_post %>
           <%= button_to create_trade_chat_path(post_id: @post.id), method: :post, class: "flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg text-center flex items-center justify-center gap-2 transition" do %>
             <span>💬 채팅하기</span>
           <% end %>
        <% end %>
      </div>
    <% end %>

    <%# Reaction Buttons %>
    <div class="flex justify-center gap-2 sm:gap-4 pt-4 sm:pt-6 border-t border-neutral-800" id="like-section">
      <%= render "likes/like_button", post: @post %>
    </div>
  </article>

  <%# Comments Section %>
  <section class="mt-6 sm:mt-8">
    <div class="flex items-center gap-2 mb-3 sm:mb-4 pb-2 border-b border-neutral-800">
      <h2 class="text-xs sm:text-sm font-bold text-white">댓글</h2>
      <span class="text-xs text-gray-500"><%= @post.comments_count %></span>
    </div>

    <%# Comment Form - Anonymous %>
    <div id="comment_<%= @post.id %>_form" class="border border-neutral-800 mb-4 sm:mb-6">
      <%= form_with model: [@post, @comment], class: "relative" do |f| %>
        <% if user_signed_in? %>
          <div class="w-full bg-neutral-900 border-b border-neutral-800 text-green-400 p-2 sm:p-3 text-xs sm:text-sm font-bold flex items-center gap-2">
            <span>👤 <%= current_user.username.presence || current_user.email.split('@').first %></span>
            <span class="text-gray-500 font-normal text-xs">(로그인됨)</span>
          </div>
          <%= f.hidden_field :commenter_name, value: current_user.username.presence || current_user.email.split('@').first %>
        <% else %>
          <%= f.text_field :commenter_name, placeholder: "이름 (선택사항)", class: "w-full bg-neutral-900 border-b border-neutral-800 text-white placeholder-gray-600 focus:ring-0 resize-none p-2 sm:p-3 text-xs sm:text-sm" %>
        <% end %>
        <%= f.text_area :content, rows: 3, placeholder: "댓글을 입력하세요...", class: "w-full bg-neutral-900 border-0 text-white placeholder-gray-600 focus:ring-0 resize-none p-2 sm:p-3 text-xs sm:text-sm" %>
        <div class="border-t border-neutral-800 p-2 text-right">
          <%= f.submit "작성", class: "bg-white text-black px-3 py-1.5 text-xs hover:bg-gray-300 cursor-pointer" %>
        </div>
      <% end %>
    </div>

    <%# Comments List - Only show top-level comments %>
    <div id="comments" class="space-y-2 sm:space-y-3">
      <% @top_level_comments.each do |comment| %>
        <%= render partial: "comments/comment", locals: { comment: comment } %>
      <% end %>
    </div>

    <% if @top_level_comments.empty? %>
      <div class="text-center py-6 sm:py-8">
        <p class="text-gray-600 text-xs">아직 작성된 댓글이 없습니다.</p>
      </div>
    <% end %>
  </section>
</main>
